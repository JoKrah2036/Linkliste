name: üîí Weekly Security Scan

on:
  schedule:
    # Jeden Montag um 9:00 Uhr UTC (10:00 Uhr MEZ / 11:00 Uhr MESZ)
    - cron: '0 9 * * 1'
  
  # Erm√∂glicht manuelles Triggern √ºber GitHub UI
  workflow_dispatch:
  
  # Optional: Bei jedem Push auf main branch
  # push:
  #   branches: [ main ]

jobs:
  security-headers-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: üìã Checkout Repository
        uses: actions/checkout@v4
      
      - name: üîç Security Headers Check
        id: security-headers
        run: |
          echo "üîç Pr√ºfe Security Headers f√ºr tipps.coreho.com..."
          
          # SecurityHeaders.com API abfragen
          RESPONSE=$(curl -s "https://api.securityheaders.com/?url=https://tipps.coreho.com")
          
          # Score extrahieren (vereinfacht - passt ggf. an)
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Security Headers Check abgeschlossen"
          echo "$RESPONSE"
      
      - name: üåê Mozilla Observatory Scan
        id: observatory
        run: |
          echo "üåê Starte Mozilla Observatory Scan..."
          
          # Scan initiieren
          SCAN_ID=$(curl -s -X POST \
            "https://http-observatory.security.mozilla.org/api/v1/analyze?host=tipps.coreho.com" \
            | jq -r '.scan_id')
          
          echo "Scan ID: $SCAN_ID"
          
          # Warte auf Scan-Ergebnis (max 60 Sekunden)
          for i in {1..12}; do
            sleep 5
            RESULT=$(curl -s "https://http-observatory.security.mozilla.org/api/v1/analyze?host=tipps.coreho.com")
            STATE=$(echo $RESULT | jq -r '.state')
            
            if [ "$STATE" = "FINISHED" ]; then
              SCORE=$(echo $RESULT | jq -r '.score')
              GRADE=$(echo $RESULT | jq -r '.grade')
              
              echo "‚úÖ Scan abgeschlossen!"
              echo "Score: $SCORE/100"
              echo "Grade: $GRADE"
              echo "score=$SCORE" >> $GITHUB_OUTPUT
              echo "grade=$GRADE" >> $GITHUB_OUTPUT
              
              # Details ausgeben
              echo $RESULT | jq '.'
              break
            fi
            
            echo "Warte auf Scan-Ergebnis... ($i/12)"
          done
      
      - name: üîê SSL Labs Check (optional)
        id: ssl-check
        run: |
          echo "üîê SSL/TLS Konfiguration pr√ºfen..."
          
          # Vereinfachter SSL Check (f√ºr detaillierten Scan ssllabs.com verwenden)
          openssl s_client -connect tipps.coreho.com:443 -servername tipps.coreho.com </dev/null 2>/dev/null | \
            openssl x509 -noout -dates
          
          echo "‚úÖ SSL Check abgeschlossen"
      
      - name: üìä Ergebnis-Summary erstellen
        run: |
          echo "# üîí Security Scan Ergebnis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Datum:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Website:** https://tipps.coreho.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìà Mozilla Observatory Score" >> $GITHUB_STEP_SUMMARY
          echo "- **Score:** ${{ steps.observatory.outputs.score }}/100" >> $GITHUB_STEP_SUMMARY
          echo "- **Grade:** ${{ steps.observatory.outputs.grade }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚úÖ Status" >> $GITHUB_STEP_SUMMARY
          
          SCORE=${{ steps.observatory.outputs.score }}
          if [ "$SCORE" -ge "90" ]; then
            echo "üü¢ **Ausgezeichnet** - Alle Sicherheitsheader korrekt konfiguriert!" >> $GITHUB_STEP_SUMMARY
          elif [ "$SCORE" -ge "70" ]; then
            echo "üü° **Gut** - Kleinere Verbesserungen m√∂glich" >> $GITHUB_STEP_SUMMARY
          else
            echo "üî¥ **Achtung** - Sicherheitsl√ºcken gefunden!" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Vollst√§ndiger Report: https://observatory.mozilla.org/analyze/tipps.coreho.com" >> $GITHUB_STEP_SUMMARY
      
      - name: ‚ö†Ô∏è Warnung bei niedrigem Score
        if: steps.observatory.outputs.score < 90
        run: |
          echo "::warning::Security Score ist unter 90! Aktueller Score: ${{ steps.observatory.outputs.score }}"
          echo "Bitte pr√ºfe: https://observatory.mozilla.org/analyze/tipps.coreho.com"
      
      - name: ‚ùå Fehlschlag bei kritischem Score
        if: steps.observatory.outputs.score < 50
        run: |
          echo "::error::KRITISCH: Security Score ist unter 50! Sofortige √úberpr√ºfung erforderlich!"
          exit 1
      
      - name: üìß Notification (optional)
        if: failure()
        run: |
          echo "Bei Bedarf hier E-Mail-Benachrichtigung oder Slack-Integration hinzuf√ºgen"
          # Beispiel mit curl zu einem Webhook:
          # curl -X POST https://hooks.slack.com/services/YOUR/WEBHOOK/URL \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"Security Scan fehlgeschlagen f√ºr tipps.coreho.com!"}'
