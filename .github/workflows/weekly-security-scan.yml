name: üîí Weekly Security Scan

on:
  schedule:
    # Jeden Montag um 9:00 Uhr UTC (10:00 Uhr MEZ / 11:00 Uhr MESZ)
    - cron: '0 9 * * 1'
  
  # Erm√∂glicht manuelles Triggern √ºber GitHub UI
  workflow_dispatch:
  
  # Optional: Bei jedem Push auf main branch
  # push:
  #   branches: [ main ]

jobs:
  security-headers-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: üìã Checkout Repository
        uses: actions/checkout@v4
      
      - name: üîç Security Headers Check
        id: security-headers
        run: |
          echo "üîç Pr√ºfe Security Headers f√ºr jokrah2036.github.io/Linkliste..."
          
          # SecurityHeaders.com API abfragen
          RESPONSE=$(curl -s "https://api.securityheaders.com/?url=https://jokrah2036.github.io/Linkliste/")
          
          # Score extrahieren (vereinfacht - passt ggf. an)
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Security Headers Check abgeschlossen"
          echo "$RESPONSE"
      
      - name: üåê Mozilla Observatory Scan
        id: observatory
        continue-on-error: true
        run: |
          echo "üåê Starte Mozilla Observatory Scan..."
          
          # Installiere jq falls nicht vorhanden
          sudo apt-get update && sudo apt-get install -y jq
          
          # Scan initiieren
          SCAN_RESULT=$(curl -s -X POST \
            "https://http-observatory.security.mozilla.org/api/v1/analyze?host=jokrah2036.github.io" \
            | jq -r '.')
          
          echo "$SCAN_RESULT"
          
          SCAN_ID=$(echo $SCAN_RESULT | jq -r '.scan_id')
          echo "Scan ID: $SCAN_ID"
          
          # Warte auf Scan-Ergebnis (max 60 Sekunden)
          for i in {1..12}; do
            sleep 5
            RESULT=$(curl -s "https://http-observatory.security.mozilla.org/api/v1/analyze?host=jokrah2036.github.io")
            STATE=$(echo $RESULT | jq -r '.state')
            
            echo "Status: $STATE"
            
            if [ "$STATE" = "FINISHED" ]; then
              SCORE=$(echo $RESULT | jq -r '.score // "0"')
              GRADE=$(echo $RESULT | jq -r '.grade // "N/A"')
              
              echo "‚úÖ Scan abgeschlossen!"
              echo "Score: $SCORE/100"
              echo "Grade: $GRADE"
              echo "score=$SCORE" >> $GITHUB_OUTPUT
              echo "grade=$GRADE" >> $GITHUB_OUTPUT
              
              # Details ausgeben
              echo $RESULT | jq '.'
              break
            fi
            
            echo "Warte auf Scan-Ergebnis... ($i/12)"
          done
          
          # Fallback wenn kein Score gefunden wurde
          if [ -z "$SCORE" ]; then
            echo "score=0" >> $GITHUB_OUTPUT
            echo "grade=N/A" >> $GITHUB_OUTPUT
          fi
      
      - name: üîê SSL Labs Check
        id: ssl-check
        continue-on-error: true
        run: |
          echo "üîê SSL/TLS Konfiguration pr√ºfen..."
          
          # Pr√ºfe SSL-Zertifikat
          echo | openssl s_client -connect jokrah2036.github.io:443 -servername jokrah2036.github.io 2>/dev/null | \
            openssl x509 -noout -dates
          
          echo "‚úÖ SSL Check abgeschlossen"
      
      - name: üåê Website Erreichbarkeit
        run: |
          echo "üåê Pr√ºfe ob Website erreichbar ist..."
          
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://jokrah2036.github.io/Linkliste/")
          
          if [ "$STATUS_CODE" = "200" ]; then
            echo "‚úÖ Website ist erreichbar (HTTP $STATUS_CODE)"
          else
            echo "‚ö†Ô∏è Website-Status: HTTP $STATUS_CODE"
          fi
          
          echo "status_code=$STATUS_CODE" >> $GITHUB_OUTPUT
      
      - name: üìä Ergebnis-Summary erstellen
        if: always()
        run: |
          echo "# üîí Security Scan Ergebnis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Datum:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Website:** https://jokrah2036.github.io/Linkliste/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Mozilla Observatory Score
          SCORE="${{ steps.observatory.outputs.score }}"
          GRADE="${{ steps.observatory.outputs.grade }}"
          
          if [ -n "$SCORE" ] && [ "$SCORE" != "0" ]; then
            echo "## üìà Mozilla Observatory Score" >> $GITHUB_STEP_SUMMARY
            echo "- **Score:** $SCORE/100" >> $GITHUB_STEP_SUMMARY
            echo "- **Grade:** $GRADE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚úÖ Status" >> $GITHUB_STEP_SUMMARY
            
            if [ "$SCORE" -ge "90" ]; then
              echo "üü¢ **Ausgezeichnet** - Alle Sicherheitsheader korrekt konfiguriert!" >> $GITHUB_STEP_SUMMARY
            elif [ "$SCORE" -ge "70" ]; then
              echo "üü° **Gut** - Kleinere Verbesserungen m√∂glich" >> $GITHUB_STEP_SUMMARY
            else
              echo "üü† **Verbesserungsbedarf** - Sicherheitsl√ºcken gefunden" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## üìà Mozilla Observatory" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Scan konnte nicht abgeschlossen werden" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Vollst√§ndiger Report: https://observatory.mozilla.org/analyze/jokrah2036.github.io" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó SecurityHeaders.com: https://securityheaders.com/?q=https://jokrah2036.github.io/Linkliste/" >> $GITHUB_STEP_SUMMARY
      
      - name: ‚ö†Ô∏è Warnung bei niedrigem Score
        if: steps.observatory.outputs.score != '' && steps.observatory.outputs.score < 90
        run: |
          echo "::warning::Security Score ist unter 90! Aktueller Score: ${{ steps.observatory.outputs.score }}"
          echo "Bitte pr√ºfe: https://observatory.mozilla.org/analyze/jokrah2036.github.io"
      
      - name: üìß Scan abgeschlossen
        if: always()
        run: |
          echo "‚úÖ Weekly Security Scan abgeschlossen!"
          echo "üìä Ergebnisse wurden in der Summary gespeichert"
          echo "üîç N√§chster automatischer Scan: N√§chsten Montag um 9:00 UTC"
