name: Security Check & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # LÃ¤uft jeden Montag um 9:00 UTC
    - cron: '0 9 * * 1'

permissions:
  contents: read
  pages: write
  id-token: write

# Verhindert gleichzeitige Deployments
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job 1: Security Checks
  security-checks:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Checks
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Check for broken links
        continue-on-error: true
        run: |
          echo "ğŸ”— Checking for broken links in HTML files..."
          
          # Extrahiere alle URLs aus index.html
          grep -oP 'href="https?://[^"]+"|src="https?://[^"]+"' index.html | \
          sed 's/href="//g; s/src="//g; s/"//g' | sort -u > urls.txt
          
          echo "ğŸ“‹ Found $(wc -l < urls.txt) unique URLs"
          
          # PrÃ¼fe jeden Link (mit Timeout)
          broken_links=0
          while IFS= read -r url; do
       # Job 2: Build and Deploy
  deploy:
    needs: security-checks
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
              echo "âœ… OK: $url"
            fi
          done < urls.txt
          
          if [ $broken_links -gt 0 ]; then
            echo "âš ï¸ Warning: $broken_links broken link(s) found"
          else
            echo "âœ… All links are working!"
          fi

      - name: ğŸ›¡ï¸ HTML Security Check
        run: |
          echo "ğŸ” Checking HTML for security issues..."
          
          # PrÃ¼fe auf potenzielle XSS-Risiken
          if grep -i "eval(" index.html; then
            echo "âŒ WARNING: eval() found - potential XSS risk!"
            exit 1
          fi
          
          if grep -i "innerHTML" index.html | grep -v "emailSpan.innerHTML"; then
            echo "âš ï¸ WARNING: innerHTML usage detected - review for XSS risks"
          fi
          
          # PrÃ¼fe auf externe Scripts ohne Integrity-Hash
          if grep -oP '<script[^>]+src="https?://[^"]+"[^>]*>' index.html | grep -v "integrity="; then
            echo "â„¹ï¸ INFO: External scripts without SRI (Subresource Integrity) detected"
            echo "Consider adding integrity hashes for better security"
          fi
          
          # PrÃ¼fe auf Meta-Tags
          if ! grep -q 'X-Content-Type-Options' index.html; then
            echo "âœ… Security meta tags should be present"
          fi
          
          echo "âœ… Basic HTML security check completed"

      - name: ğŸ“Š Validate HTML Structure
        run: |
          echo "ğŸ“ Validating HTML structure..."
          
          # PrÃ¼fe auf DOCTYPE
          if ! grep -q '<!DOCTYPE html>' index.html; then
            echo "âŒ Missing DOCTYPE declaration"
            exit 1
          fi
          
          # PrÃ¼fe auf grundlegende HTML-Struktur
          if ! grep -q '<html' index.html || ! grep -q '</html>' index.html; then
            echo "âŒ Invalid HTML structure"
            exit 1
          fi
          
          if ! grep -q '<head>' index.html || ! grep -q '</head>' index.html; then
            echo "âŒ Missing head section"
            exit 1
          fi
          
          if ! grep -q '<body>' index.html || ! grep -q '</body>' index.html; then
            echo "âŒ Missing body section"
            exit 1
          fi
          
          echo "âœ… HTML structure is valid"

      - name: ğŸ” Check CSP Headers
        run: |
          echo "ğŸ›¡ï¸ Analyzing Content Security Policy..."
          
          if grep -q "Content-Security-Policy" index.html; then
            echo "âœ… CSP meta tag found in HTML"
            grep "Content-Security-Policy" index.html
          else
            echo "â„¹ï¸ No CSP meta tag found - consider adding one"
          fi

      - name: ğŸŒ API Endpoint Check
        continue-on-error: true
        run: |
          echo "ğŸ”Œ Testing external API endpoints..."
          
          # Test Alternative.me Fear & Greed API
          if curl -s -f "https://api.alternative.me/fng/?limit=1" > /dev/null; then
            echo "âœ… Fear & Greed API is reachable"
          else
            echo "âš ï¸ Fear & Greed API might be down"
          fi
          
          # Test Formspree endpoint (nur Erreichbarkeit, nicht POST)
          if curl -s -f -I "https://formspree.io" > /dev/null; then
            echo "âœ… Formspree is reachable"
          else
            echo "âš ï¸ Formspree might be down"
          fi

      - name: ğŸ“ˆ Generate Security Report
        if: always()
        run: |
          echo "ğŸ“‹ Security Check Summary"
          echo "=========================="
          echo "âœ… Repository: ${{ github.repository }}"
          echo "âœ… Branch: ${{ github.ref_name }}"
          echo "âœ… Commit: ${{ github.sha }}"
          echo "âœ… Triggered by: ${{ github.event_name }}"
          echo "=========================="
          echo "ğŸ‰ Security checks completed!"

  # Job 2: Build and Deploy
  deploy:
    needs: security-checks
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to GitHub Pages
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¦ Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… Deployment Complete
        run: |
          echo "ğŸ‰ Successfully deployed to GitHub Pages!"
          echo "ğŸŒ Your site is live at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
